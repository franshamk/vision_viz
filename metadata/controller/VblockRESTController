{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "visionURL": "https://fm-sim-nimsoft.internal.superna.net:8443",
        "visionUser": "admin",
        "visionPass": "dangerous",
        "designer|userClassName": "VblockRESTController"
    },
    "designerId": "45e13f6d-91c7-4914-ac82-4fd329a935b7",
    "customConfigs": [
        {
            "group": "(Custom Properties)",
            "name": "visionURL",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "visionUser",
            "type": "string"
        },
        {
            "group": "(Custom Properties)",
            "name": "visionPass",
            "type": "string"
        }
    ],
    "cn": [
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "getBaseResource",
                "designer|params": [
                    "url",
                    "ticket"
                ],
                "implHandler": [
                    "var me = this;\r",
                    "\r",
                    "url = this.config.visionURL + url;\r",
                    "\r",
                    "if(ticket) {\r",
                    "    url = url +\"?ticket=\" + ticket;\r",
                    "}\r",
                    "\r",
                    "\r",
                    "\r",
                    "Ext.Ajax.request({\r",
                    "    method: 'GET',\r",
                    "    url: url,\r",
                    "    useDefaultXhrHeader: false,\r",
                    "    success: function(data) {  \r",
                    "\r",
                    "        var parser=new DOMParser();\r",
                    "        var\txmlDoc=parser.parseFromString(data.responseText,\"text/xml\");\r",
                    "\r",
                    "        var vbs = me.xmlToJson(xmlDoc);\r",
                    "\r",
                    "\r",
                    "        for(var i in vbs.vblocks) {\r",
                    "\r",
                    "            if(i != 'vblock') {\r",
                    "                continue;\r",
                    "            }\r",
                    "\r",
                    "            var vb = vbs.vblocks[i];\r",
                    "\r",
                    "            // these should be the individual vblocks\r",
                    "            console.log(vb);\r",
                    "            var comp = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text:'compute',\r",
                    "                link: vb.compute.link[0]['@attributes'].href\r",
                    "            });\r",
                    "\r",
                    "            var network = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text:'network',\r",
                    "                link: vb.network.link[0]['@attributes'].href\r",
                    "            });   \r",
                    "\r",
                    "            var storage = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text:'storage',\r",
                    "                link: vb.storage.link[0]['@attributes'].href\r",
                    "            });    \r",
                    "\r",
                    "            var conn = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text:'connectivity',\r",
                    "                link: vb.connectivity.link[0]['@attributes'].href\r",
                    "            });     \r",
                    "\r",
                    "            var rack = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text:'rack',\r",
                    "                link: vb.rack.link[0]['@attributes'].href\r",
                    "            });          \r",
                    "\r",
                    "            var vb = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text:'vblock ' + vb.serialNum['#text'],\r",
                    "                children: [comp, network, storage, conn, rack]\r",
                    "            });\r",
                    "\r",
                    "            Ext.getStore('VblockTreeStore').getRoot().appendChild(vb);\r",
                    "\r",
                    "        } \r",
                    "\r",
                    "    }\r",
                    "});\r",
                    "\r",
                    "\r",
                    ""
                ]
            },
            "designerId": "32af46b9-416e-4e9a-bd57-eeb207e5e994"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "getResource",
                "designer|params": [
                    "url, ticket"
                ],
                "implHandler": [
                    "\r",
                    "alert(\"getting respource\");\r",
                    "url = this.config.visionURL + url;\r",
                    "\r",
                    "var me = this;\r",
                    "Ext.Ajax.request({\r",
                    "    method: 'GET',\r",
                    "    url: url,\r",
                    "    useDefaultXhrHeader: false,\r",
                    "    success: function(data) {        \r",
                    "        alert(data.responseText); \r",
                    "    }\r",
                    "});\r",
                    ""
                ]
            },
            "designerId": "2883a432-e746-4858-bea2-0380aa8011d1"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "doLogin",
                "implHandler": [
                    "var me = this;\r",
                    "\r",
                    "var cas = me.config.visionURL + \"/cas/v1/tickets\";\r",
                    "var base = \"/fm/vblocks\";\r",
                    "\r",
                    "\r",
                    "alert('doing login');\r",
                    "\r",
                    "Ext.Ajax.request({\r",
                    "    method: 'POST',\r",
                    "    url: cas,\r",
                    "    params: {\r",
                    "        username: me.config.visionUser,\r",
                    "        password: me.config.visionPass\r",
                    "    },\r",
                    "    useDefaultXhrHeader: false,\r",
                    "    success: function(data) {   \r",
                    "        \r",
                    "        alert('got ticketGrantingTicket');\r",
                    "        var el = document.createElement('div');\r",
                    "        el.innerHTML = data.responseText;        \r",
                    "        var list = el.getElementsByTagName('form');\r",
                    "        me.ticketGrantingTicket = list[0].action;\r",
                    "\r",
                    "        // NExt, get a service ticket. \r",
                    "        Ext.Ajax.request({\r",
                    "            method: 'POST',\r",
                    "            url: me.ticketGrantingTicket,\r",
                    "            params: {\r",
                    "                service: me.config.visionURL + base\r",
                    "            },\r",
                    "            useDefaultXhrHeader: false,\r",
                    "            success: function(data) {        \r",
                    "                alert(data.responseText); \r",
                    "                // fetch the resource on success. \r",
                    "                me.getBaseResource(base, data.responseText);\r",
                    "            }\r",
                    "        });\r",
                    "    }\r",
                    "});"
                ]
            },
            "designerId": "af3cbfd9-bd02-4afe-af3b-12f59bc65849"
        },
        {
            "type": "fixedfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "init",
                "designer|params": [
                    "application"
                ],
                "implHandler": [
                    "this.doLogin();"
                ]
            },
            "designerId": "81465ace-cf52-4455-88d6-138ceb7cf159"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "xmlToJson",
                "designer|params": [
                    "xml"
                ],
                "implHandler": [
                    "var me = this;\r",
                    "\r",
                    "//Create the return object\r",
                    "var obj = {};\r",
                    "\r",
                    "if (xml.nodeType == 1) { // element\r",
                    "    // do attributes\r",
                    "    if (xml.attributes.length > 0) {\r",
                    "        obj[\"@attributes\"] = {};\r",
                    "        for (var j = 0; j < xml.attributes.length; j++) {\r",
                    "            var attribute = xml.attributes.item(j);\r",
                    "            obj[\"@attributes\"][attribute.nodeName] = attribute.nodeValue;\r",
                    "        }\r",
                    "    }\r",
                    "} else if (xml.nodeType == 3) { // text\r",
                    "    obj = xml.nodeValue;\r",
                    "}\r",
                    "\r",
                    "// do children\r",
                    "if (xml.hasChildNodes()) {\r",
                    "    for(var i = 0; i < xml.childNodes.length; i++) {\r",
                    "        var item = xml.childNodes.item(i);\r",
                    "        var nodeName = item.nodeName;\r",
                    "        if (typeof(obj[nodeName]) == \"undefined\") {\r",
                    "            obj[nodeName] = me.xmlToJson(item);\r",
                    "        } else {\r",
                    "            if (typeof(obj[nodeName].push) == \"undefined\") {\r",
                    "                var old = obj[nodeName];\r",
                    "                obj[nodeName] = [];\r",
                    "                obj[nodeName].push(old);\r",
                    "            }\r",
                    "            obj[nodeName].push(me.xmlToJson(item));\r",
                    "        }\r",
                    "    }\r",
                    "}\r",
                    "return obj;"
                ]
            },
            "designerId": "13a35585-d759-41ee-9256-2ac7298d1e30"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "onDynListItemTap",
                "designer|params": [
                    "nestedlist, list, index, target, record, e, eOpts"
                ],
                "implHandler": [
                    "var me = this;\r",
                    "\r",
                    "var onSuccess =  function(data) {\r",
                    "    var children = me.processDoc(data.responseText);  \r",
                    "    \r",
                    "    if(!children || children.length == 0) {\r",
                    "        return;\r",
                    "    }\r",
                    "    \r",
                    "    children.forEach(function(child) {\r",
                    "        record.appendChild(child);\r",
                    "    });\r",
                    "    updateViews();\r",
                    "};\r",
                    "\r",
                    "var updateViews = function () {\r",
                    "    alert('updating views');\r",
                    "    history.pushState();\r",
                    "    me.getApplication().getController('NavSheetController').doSelectionChange(record.id);    \r",
                    "    nestedlist.fireEvent('levelloaded', this, list, index, target, record, e);\r",
                    "};   \r",
                    "\r",
                    "\r",
                    "if(record.hasChildNodes()) {\r",
                    "    updateViews();\r",
                    "    return;\r",
                    "} \r",
                    "\r",
                    "alert(record.get('link'));\r",
                    "\r",
                    "// need to add loadmask here\r",
                    "Ext.Ajax.request({\r",
                    "    method: 'GET',\r",
                    "    url: record.get('link'),\r",
                    "    useDefaultXhrHeader: false,\r",
                    "    success: onSuccess\r",
                    "});"
                ]
            },
            "designerId": "c20bc1e0-2108-492a-b27a-6422b88e8467"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "processDoc",
                "designer|params": [
                    "xml"
                ],
                "implHandler": [
                    "var parser=new DOMParser();\r",
                    "var\txmlDoc=parser.parseFromString(xml,\"text/xml\");\r",
                    "\r",
                    "var topcontainer = this.xmlToJson(xmlDoc);  // computesystems\r",
                    "console.log(topcontainer);\r",
                    "\r",
                    "var models = []\r",
                    "\r",
                    "for(var i in topcontainer) {\r",
                    "    var elements = topcontainer[i];\r",
                    "    \r",
                    "    for(var j in elements) { // computesystem[]   \r",
                    "    \r",
                    "        var element = elements[j]; // computesystem  THIS IS THE MODEL. \r",
                    "        \r",
                    "        // append the links as children to this model. \r",
                    "        \r",
                    "        if(!element.link) {\r",
                    "            console.log(\"no links in element\");\r",
                    "            console.log(element);\r",
                    "            continue;\r",
                    "        }\r",
                    "        \r",
                    "        for (var child in element.link) {\r",
                    "            var url = element.link[child]['@attributes'].href;\r",
                    "            var name = url.split('/').pop();\r",
                    "            \r",
                    "            var model = Ext.create('MyApp.model.TreeModel', {\r",
                    "                text: name,\r",
                    "                link: url\r",
                    "            });\r",
                    "            models.push(model);\r",
                    "        }\r",
                    "    }\r",
                    "    \r",
                    "}\r",
                    "\r",
                    "return models;"
                ]
            },
            "designerId": "4ea76852-2fca-4fd5-a254-47bd4c640b82"
        }
    ]
}